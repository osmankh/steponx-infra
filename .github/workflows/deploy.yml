# Infrastructure deployment workflow
# - PRs: plans all stacks and posts as PR comments
# - Push to main: plans and applies stacks in order (common -> backend)
# - Manual dispatch: select which stack(s) to deploy

name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths:
      - "stacks/**"
      - "modules/**"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      stack:
        description: "Stack to deploy"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - common
          - backend

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  AWS_REGION: eu-central-1
  TF_STATE_BUCKET: steponx-terraform-state
  TF_LOCK_TABLE: steponx-terraform-locks

jobs:
  # ---------------------------------------------------------------------------
  # Plan jobs - run on every trigger
  # ---------------------------------------------------------------------------
  plan-common:
    name: Plan Common Stack
    runs-on: ubuntu-latest
    if: >-
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.stack == 'all' ||
      github.event.inputs.stack == 'common'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "~1.9"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: OpenTofu Init
        working-directory: stacks/common/
        run: |
          tofu init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=common/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: OpenTofu Plan
        id: plan
        working-directory: stacks/common/
        run: |
          tofu plan -out=plan.tfplan -no-color 2>&1 | tee plan-output.txt
          echo "plan_text<<PLAN_EOF" >> $GITHUB_OUTPUT
          head -c 60000 plan-output.txt >> $GITHUB_OUTPUT
          echo "PLAN_EOF" >> $GITHUB_OUTPUT

      - name: Post plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const plan = `${{ steps.plan.outputs.plan_text }}`;
            const body = `### Terraform Plan - Common Stack

            <details>
            <summary>Show Plan</summary>

            \`\`\`hcl
            ${plan}
            \`\`\`

            </details>

            *Pushed by @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  plan-backend:
    name: Plan Backend Stack
    runs-on: ubuntu-latest
    if: >-
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.stack == 'all' ||
      github.event.inputs.stack == 'backend'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "~1.9"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: OpenTofu Init
        working-directory: stacks/backend/
        run: |
          tofu init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=backend/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: OpenTofu Plan
        id: plan
        working-directory: stacks/backend/
        run: |
          tofu plan -out=plan.tfplan -no-color 2>&1 | tee plan-output.txt
          echo "plan_text<<PLAN_EOF" >> $GITHUB_OUTPUT
          head -c 60000 plan-output.txt >> $GITHUB_OUTPUT
          echo "PLAN_EOF" >> $GITHUB_OUTPUT

      - name: Post plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const plan = `${{ steps.plan.outputs.plan_text }}`;
            const body = `### Terraform Plan - Backend Stack

            <details>
            <summary>Show Plan</summary>

            \`\`\`hcl
            ${plan}
            \`\`\`

            </details>

            *Pushed by @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ---------------------------------------------------------------------------
  # Apply jobs - only on push to main or manual dispatch
  # ---------------------------------------------------------------------------
  apply-common:
    name: Apply Common Stack
    runs-on: ubuntu-latest
    needs: plan-common
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.stack == 'all' || github.event.inputs.stack == 'common'))
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "~1.9"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: OpenTofu Init
        working-directory: stacks/common/
        run: |
          tofu init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=common/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: OpenTofu Apply
        working-directory: stacks/common/
        run: tofu apply -auto-approve

      - name: Post outputs to summary
        working-directory: stacks/common/
        run: |
          echo "## Common Stack Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tofu output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  apply-backend:
    name: Apply Backend Stack
    runs-on: ubuntu-latest
    needs: apply-common
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.stack == 'all' || github.event.inputs.stack == 'backend'))
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "~1.9"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: OpenTofu Init
        working-directory: stacks/backend/
        run: |
          tofu init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=backend/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: OpenTofu Apply
        working-directory: stacks/backend/
        run: tofu apply -auto-approve

      - name: Post outputs to summary
        working-directory: stacks/backend/
        run: |
          echo "## Backend Stack Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tofu output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
